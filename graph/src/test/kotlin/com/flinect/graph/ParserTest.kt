package com.flinect.graph

import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Tag
import org.junit.jupiter.api.Test
import java.io.InputStreamReader

@Tag("unit")
class ParserTest {
    val schema = SchemaBuilder.create {
        node("action") {
            event("execute")
        }
        node("text") {
            input("value", DataType.STRING)
            output("out-value", DataType.STRING)
        }
        node("print") {
            command("print")
            input("content", DataType.STRING)
        }
    }

    @Test
    fun basic() {
        val file = this::class.java.classLoader.getResourceAsStream("basic-graph.json")!!
        val graph = Parser.fromJson(schema, InputStreamReader(file))

        assertEquals(
            "{\"nodes\":{\"a1\":{\"node\":{\"id\":\"action\",\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}}},\"key\":\"a1\",\"values\":{},\"inputs\":{},\"outputs\":{\"execute\":[{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}]}},\"p1\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{\"print\":{\"nodeInstance\":{\"node\":{\"id\":\"action\",\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}}},\"key\":\"a1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"content\":{\"nodeInstance\":{\"node\":{\"id\":\"text\",\"properties\":{\"value\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"out-value\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}}},\"key\":\"t1\",\"values\":{\"value\":{\"property\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"value\":{\"value\":\"Hello\",\"type\":\"STRING\"}}},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}}},\"outputs\":{}},\"t1\":{\"node\":{\"id\":\"text\",\"properties\":{\"value\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"out-value\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}}},\"key\":\"t1\",\"values\":{\"value\":{\"property\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"value\":{\"value\":\"Hello\",\"type\":\"STRING\"}}},\"inputs\":{},\"outputs\":{\"out-value\":[{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}]}}},\"edges\":{\"edgeMap\":{\"action#a1@execute\\u003eprint#p1@print\":{\"source\":{\"nodeInstance\":{\"node\":{\"id\":\"action\",\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}}},\"key\":\"a1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}},\"text#t1@out-value\\u003eprint#p1@content\":{\"source\":{\"nodeInstance\":{\"node\":{\"id\":\"text\",\"properties\":{\"value\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"out-value\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}}},\"key\":\"t1\",\"values\":{\"value\":{\"property\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"value\":{\"value\":\"Hello\",\"type\":\"STRING\"}}},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}}},\"inputs\":{\"print#p1@print\":{\"source\":{\"nodeInstance\":{\"node\":{\"id\":\"action\",\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}}},\"key\":\"a1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}},\"print#p1@content\":{\"source\":{\"nodeInstance\":{\"node\":{\"id\":\"text\",\"properties\":{\"value\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"out-value\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}}},\"key\":\"t1\",\"values\":{\"value\":{\"property\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"value\":{\"value\":\"Hello\",\"type\":\"STRING\"}}},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}}},\"outputs\":{\"action#a1@execute\":[{\"source\":{\"nodeInstance\":{\"node\":{\"id\":\"action\",\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}}},\"key\":\"a1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}}],\"text#t1@out-value\":[{\"source\":{\"nodeInstance\":{\"node\":{\"id\":\"text\",\"properties\":{\"value\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"out-value\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}}},\"key\":\"t1\",\"values\":{\"value\":{\"property\":{\"type\":\"STRING\",\"id\":\"value\",\"direction\":\"IN\"},\"value\":{\"value\":\"Hello\",\"type\":\"STRING\"}}},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"out-value\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"node\":{\"id\":\"print\",\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}},\"key\":\"p1\",\"values\":{},\"inputs\":{},\"outputs\":{}},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}}]}}}".hashCode(),
            TestUtil.toJson(graph).hashCode()
        )
    }
}

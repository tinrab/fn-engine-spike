package com.flinect.graph

import com.flinect.scrap.common.JsonUtil
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Tag
import org.junit.jupiter.api.Test
import java.io.InputStreamReader

@Tag("unit")
class ParserTest {
    val schema = SchemaBuilder.create {
        gate("action") {
            event("execute")
        }
        gate("print") {
            command("print")
            input("content", DataType.STRING)
        }
        structure("user") {
            property("name", DataType.STRING)
        }
    }

    @Test
    fun basic() {
        val file = this::class.java.classLoader.getResourceAsStream("basic-graph.json")!!
        val graph = Parser.fromJson(schema, InputStreamReader(file))

        assertEquals(
            "{\"nodes\":{\"a1\":{\"gate\":{\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"id\":\"action\"},\"values\":{},\"inputs\":{},\"outputs\":{\"execute\":[{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}]},\"id\":\"action\",\"key\":\"a1\"},\"p1\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"inputs\":{\"print\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"id\":\"action\"},\"values\":{},\"id\":\"action\",\"key\":\"a1\"},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"content\":{\"nodeInstance\":{\"structure\":{\"properties\":{\"name\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"id\":\"user\"},\"values\":{\"name\":{\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"},\"value\":{\"value\":\"John Oldman\",\"type\":\"STRING\"}}},\"id\":\"user\",\"key\":\"u1\"},\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}}},\"outputs\":{},\"id\":\"print\",\"key\":\"p1\"},\"u1\":{\"structure\":{\"properties\":{\"name\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"id\":\"user\"},\"values\":{\"name\":{\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"},\"value\":{\"value\":\"John Oldman\",\"type\":\"STRING\"}}},\"inputs\":{},\"outputs\":{\"name\":[{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}]},\"id\":\"user\",\"key\":\"u1\"}},\"edges\":{\"edgeMap\":{\"action#a1@execute\\u003eprint#p1@print\":{\"source\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"id\":\"action\"},\"values\":{},\"id\":\"action\",\"key\":\"a1\"},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}},\"user#u1@name\\u003eprint#p1@content\":{\"source\":{\"nodeInstance\":{\"structure\":{\"properties\":{\"name\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"id\":\"user\"},\"values\":{\"name\":{\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"},\"value\":{\"value\":\"John Oldman\",\"type\":\"STRING\"}}},\"id\":\"user\",\"key\":\"u1\"},\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}}},\"inputs\":{\"print#p1@print\":{\"source\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"id\":\"action\"},\"values\":{},\"id\":\"action\",\"key\":\"a1\"},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}},\"print#p1@content\":{\"source\":{\"nodeInstance\":{\"structure\":{\"properties\":{\"name\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"id\":\"user\"},\"values\":{\"name\":{\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"},\"value\":{\"value\":\"John Oldman\",\"type\":\"STRING\"}}},\"id\":\"user\",\"key\":\"u1\"},\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}}},\"outputs\":{\"action#a1@execute\":[{\"source\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"execute\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"id\":\"action\"},\"values\":{},\"id\":\"action\",\"key\":\"a1\"},\"property\":{\"id\":\"execute\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"id\":\"print\",\"direction\":\"IN\"}}}],\"user#u1@name\":[{\"source\":{\"nodeInstance\":{\"structure\":{\"properties\":{\"name\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"id\":\"user\"},\"values\":{\"name\":{\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"},\"value\":{\"value\":\"John Oldman\",\"type\":\"STRING\"}}},\"id\":\"user\",\"key\":\"u1\"},\"property\":{\"type\":\"STRING\",\"id\":\"name\",\"direction\":\"OUT\"}},\"target\":{\"nodeInstance\":{\"gate\":{\"properties\":{\"print\":{\"id\":\"print\",\"direction\":\"IN\"},\"content\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}},\"id\":\"print\"},\"values\":{},\"id\":\"print\",\"key\":\"p1\"},\"property\":{\"type\":\"STRING\",\"id\":\"content\",\"direction\":\"IN\"}}}]}}}".hashCode(),
            JsonUtil.encode(graph).hashCode()
        )
    }
}
